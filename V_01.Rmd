---
title: "Sample_Code"
author: "Caroline X Gao"
date: "29/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Install dev_package(s)
# Load dev_package(s)
library(depmixS4) # Must be in depends of pkg
library(ready4use)
```
```{r child="Functions.Rmd", echo=FALSE}
```

```{r}
sessionInfo()
```

## Import data

```{r}
ds_tb <- ready4use::Ready4useRepos(dv_nm_1L_chr = "fakes",
                               dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/W95KED",
                               dv_server_1L_chr = "dataverse.harvard.edu") %>%
  ingest(fls_to_ingest_chr = "ymh_clinical_dyad_r4") %>%
  procureSlot("b_Ready4useIngest") %>%
  procure("ymh_clinical_dyad_r4") %>%
  procureSlot(slot_nm_1L_chr = "ds_tb") %>% 
    dplyr::rename_with(~stringr::str_replace(.,"aqol6d_q","Q"), .cols = everything()) %>%
  dplyr::rename(ID = fkClientID) %>%
  dplyr::filter(round == "Baseline")
```

```{r}
set.seed(12345)
```

```{r}
folds_int <- caret::createFolds(ds_tb$Q1, k = 10,list = FALSE)
```

```{r}
cv_results_ls <- readRDS("CV_results.rds")
if(is.null(cv_results_ls)){
    cv_results_ls <- make_cvdn_ls(ds_tb,
                                 folds_int = folds_int,
                                 var_nms_chr = paste0("Q",
                                                      1:20)
                                 ) # CHANGE TO RESULTS_LS
    saveRDS(cv_results_ls,  "CV_results.rds") # CHANGE TO RESULTS_LS
}
```

```{r}
cv_ds_tb <- make_cv_ds(cv_results_ls)
```
## Plot average fitting index

```{r}
averate_fit_plt <- plot_average_fit(cv_ds_tb)
averate_fit_plt
```

## Plot individual fitting index
```{r}
individual_fit_plt <- plot_individual_fit(cv_ds_tb)
individual_fit_plt
```

## Agreements between folds
Use Rand index to calculate agreement between each fold.
```{r}
calculate_mean_RI(cv_results_ls,
                  ds_tb = ds_tb,
                  select_from_ls_1L_int = 2L,
                  select_from_df_int = c(1L,4L))
```

## LOSO CV
Find the best number of classes.

```{r}
folds_int <- as.factor(ds_tb$s_centre) %>%# EDITED
  as.numeric() # GENERALISE VARIABLE SELECTION
loso_results_ls <- readRDS("LOSO_CV_results.rds") # MAKE THIS A FUNCTION.
if(is.null(loso_results_ls)){
  loso_results_ls <- make_cvdn_ls(ds_tb,folds_int) 
  saveRDS(loso_results_ls,  
          "LOSO_CV_results.rds")
}
```

```{r}
loso_ds_tb <- make_cv_ds(loso_results_ls)
```
## Plot average fitting index

```{r}
averate_fit_plt <- plot_average_fit(loso_ds_tb)
averate_fit_plt
```

## Plot individual fitting index
```{r}
individual_fit_plt <- plot_individual_fit(loso_ds_tb)
individual_fit_plt
```
## Agreements between folds
Use Rand index to calculate agreement between each fold.
```{r}
calculate_mean_RI(loso_results_ls, # NOT WORKING
                  ds_tb = ds_tb,
                  select_from_ls_1L_int = 2L,
                  select_from_df_int = c(1L,4L))
```

## Split half CV

The testing data is much smaller than the training data and can be a biased representation of the data. Therefore we only broadly evaluate whether the 4 cluster solution identifies similar group membership. 


```{r,fig.height=8,fig.width=10}
print_cluster_plots(ds_tb,
                    clusters_1L_int = 4,
                    var_nms_chr = paste0("Q",1:20),
                    nbr_of_folds_1L_int = 2L)
 
```

## Final clustering 

```{r}
model_mdl <- fit_mix(ds_tb,
                    clusters_1L_int = 4,
                    var_nms_chr = paste0("Q",1:20))
summary(model_mdl)
```
```{r}
ds_tb <- add_class_var(ds_tb,
                       clusters_1L_int = 4,
                       model_mdl = model_mdl)
```

### Plot

```{r,fig.height=8,fig.width=10, message=FALSE} 
plot_cluster(ds_tb,
             cluster_int = ds_tb$class_int)
```

### PCA visulisation 

```{r}
pca_df <- make_pca_tbl(ds_tb,
                      var_nms_chr = paste0("Q",1:20),
                     class_var_nm_1L_chr = "class_int")
plot_pca(ds_tb,
         pca_df = pca_df,
         class_var_nm_1L_chr = "class_int")
```
## Sensitivity analysis 

Sensitivity analysis with k-means clustering based on first five principal compoments. 
 
```{r}
ds_tb <- add_kmeans_cls_var(ds_tb,
                            classes_1L_int = 4L,
                            components_1L_int = 5L,
                            pca_df = pca_df,
                            start_1L_int = 25L)
#cross tabulate
table(ds_tb$class_int, 
      ds_tb$kmeans_cls_int)

```
```{r}
#check Rand Index
aricode::RI(ds_tb$class_int,
            ds_tb$kmeans_cls_int)
```
```{r,fig.height=8,fig.width=10} 
plot_cluster(ds_tb,
             cluster_int = ds_tb$kmeans_cls_int)
```








